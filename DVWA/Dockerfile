FROM ubuntu:14.04

MAINTAINER MyKings <xsseroot@gmail.com>

# 使用国内淘宝源
ADD sources.list /etc/apt/

# 安装服务
RUN apt-get -y update \
  && apt-get -y install php5 php5-mysqlnd php5-gd mysql-server wget unzip curl supervisor

# 设置 root 密码
RUN /etc/init.d/mysql start &&\
    mysql -e "grant all privileges on *.* to 'root'@'localhost' identified by 'p@ssw0rd';"&&\
    mysql -u root -pp@ssw0rd -e "show databases;"

# 修改 php.ini
RUN sed -i 's/allow_url_include = Off/allow_url_include = On/g' /etc/php5/apache2/php.ini

# 切换工作目录
WORKDIR /var/www/html/

# 拷贝监控服务配置
COPY ./dvwa.conf /etc/supervisor/conf.d/dvwa.conf

# 删除默认首页
RUN rm /var/www/html/index.html

# 下载 DVWA
RUN wget --no-check-certificate https://github.com/ethicalhack3r/DVWA/archive/v1.9.zip\
  && unzip v1.9.zip\
  && rm v1.9.zip\
  && mv DVWA-1.9/* .\
  && rm -rf DVWA-1.9/\
  && chmod -R 777 ./hackable/ ./external//

# 拷贝启动脚本
# 这里缺少startup.sh文件
ADD ./startup.sh ./

EXPOSE 80

CMD ["/usr/bin/supervisord"]
